@page "/register"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using CarRentalApp.Infrastructure.Data
@using CarRentalApp.Domain.Entities
@inject UserManager<IdentityUser> UserManager
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation

<h3>Zarejestruj siê</h3>

<EditForm Model="Input" FormName="register" OnValidSubmit="RejestrujUzytkownika">
    <DataAnnotationsValidator />

    <div>
        <label>Imiê:</label>
        <InputText @bind-Value="Input.FirstName" class="form-control" />
        <ValidationMessage For="@(() => Input.FirstName)" />
    </div>

    <div>
        <label>Nazwisko:</label>
        <InputText @bind-Value="Input.LastName" class="form-control" />
        <ValidationMessage For="@(() => Input.LastName)" />
    </div>

    <div>
        <label>Numer prawa jazdy:</label>
        <InputText @bind-Value="Input.DriverLicense" class="form-control" />
        <ValidationMessage For="@(() => Input.DriverLicense)" />
    </div>

    <div>
        <label>E-mail:</label>
        <InputText @bind-Value="Input.Email" class="form-control" />
        <ValidationMessage For="@(() => Input.Email)" />
    </div>

    <div>
        <label>Has³o:</label>
        <InputText @bind-Value="Input.Password" type="password" class="form-control" />
        <ValidationMessage For="@(() => Input.Password)" />
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }

    <button type="submit" class="btn btn-primary">Zarejestruj siê</button>
</EditForm>

@code {
    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    private string? errorMessage;

    private async Task RejestrujUzytkownika()
    {
        var user = new IdentityUser { UserName = Input.Email, Email = Input.Email };
        var result = await UserManager.CreateAsync(user, Input.Password);

        if (result.Succeeded)
        {
            await UserManager.AddToRoleAsync(user, "User");

            var client = new Client
            {
                FirstName = Input.FirstName,
                LastName = Input.LastName,
                DriverLicense = Input.DriverLicense,
                UserId = user.Id
            };

            DbContext.Clients.Add(client);
            await DbContext.SaveChangesAsync();

            Navigation.NavigateTo("/login");
        }
        else
        {
            errorMessage = string.Join(", ", result.Errors.Select(e => e.Description));
        }
    }

    private sealed class InputModel
    {
        [Required]
        public string FirstName { get; set; } = "";

        [Required]
        public string LastName { get; set; } = "";

        [Required]
        [Length(10, 10)]
        public string DriverLicense { get; set; } = "";

        [Required]
        [EmailAddress]
        public string Email { get; set; } = "";

        [Required]
        [DataType(DataType.Password)]
        public string Password { get; set; } = "";
    }
}