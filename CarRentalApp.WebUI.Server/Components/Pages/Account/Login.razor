@page "/login"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@inject SignInManager<IdentityUser> SignInManager
@inject NavigationManager Navigation

<h3>Zaloguj siê</h3>

<EditForm Model="Input" FormName="login" OnValidSubmit="ZalogujUzytkownika">
    <DataAnnotationsValidator />

    <div>
        <label>E-mail:</label>
        <InputText @bind-Value="Input.Email" class="form-control" />
        <ValidationMessage For="@(() => Input.Email)" />
    </div>

    <div>
        <label>Password:</label>
        <InputText @bind-Value="Input.Password" type="password" class="form-control" />
        <ValidationMessage For="@(() => Input.Password)" />
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }

    <button type="submit" class="btn btn-primary">Zaloguj siê</button>
</EditForm>

@code {
    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }

    private string? errorMessage;

    private async Task ZalogujUzytkownika()
    {
        var result = await SignInManager.PasswordSignInAsync(Input.Email, Input.Password, true, false);

        if (result.Succeeded)
        {
            Navigation.NavigateTo(ReturnUrl ?? "/", true);
        }
        else
        {
            errorMessage = "Invalid email or password.";
        }
    }

    private sealed class InputModel
    {
        [Required]
        [EmailAddress]
        public string Email { get; set; } = "";

        [Required]
        [DataType(DataType.Password)]
        public string Password { get; set; } = "";
    }
}
